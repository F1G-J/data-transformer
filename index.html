<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Legacy Data Transformer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; font-family: monospace; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f2f2f2; }
    button { padding: 10px 16px; font-size: 15px; margin-right: 10px; }
    pre { background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>Legacy Data Transformer</h2>
<p>Paste your exported legacy data below (from enhanced or legacy screen):</p>
<textarea id="rawData" placeholder="Paste legacy export here..."></textarea><br/>
<button onclick="processData()">Process</button>
<button onclick="downloadCSV()">Download CSV</button>

<div id="headerSection">
  <h3>Main Information</h3>
  <pre id="headerInfo"></pre>
</div>

<table id="outputTable">
  <thead>
    <tr>
      <th>Event ID</th>
      <th>Equip ID</th>
      <th>WUC</th>
      <th>Discrepancy</th>
      <th>WCE Sequence</th>
      <th>PWC</th>
      <th>NARR</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
function processData() {
  const input = document.getElementById("rawData").value;
  const lines = input.split("\n");
  const tbody = document.querySelector("#outputTable tbody");
  const headerInfo = document.getElementById("headerInfo");
  tbody.innerHTML = "";
  headerInfo.textContent = "";

  const wceBlocks = [];
  let discrepancy = "";
  let eventId = "";
  let equipId = "";
  let wuc = "";
  let symbol = "";
  let priority = "";
  let scheduledDate = "";

  // Iterate through all lines
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Parse main data line (Event ID, Equip ID, WUC, etc.)
    if (line.match(/^!*\$\$\$\$/)) {
      const parts = line.trim().split(/\s+/);

      eventId = parts[0].replace(/!/g, '').trim(); // Event ID
      equipId = parts[1].replace(/!/g, '').trim(); // Equip ID
      wuc = parts[2].replace(/!/g, '').trim(); // WUC
      symbol = parts[3]?.trim() || ""; // Symbol
      priority = parts[4]?.trim() || ""; // Priority (adjusted to fetch both characters)
      scheduledDate = parts[8]?.trim() || ""; // Scheduled Date (adjusted index)
    }

    // Parse discrepancy and continuation
    if (line.startsWith("DISCREPANCY:")) {
      discrepancy = line.replace("DISCREPANCY:", "").trim();
      if (lines[i + 1] && lines[i + 1].trim() !== "") {
        discrepancy += " " + lines[i + 1].trim();
      }
    }

    // Parse WCE blocks
    if (line.trim().startsWith("WCE-SEQ")) {
      let j = i + 1;
      while (j < lines.length) {
        const dataLine = lines[j]?.trim() || "";
        if (!/^\d{3}/.test(dataLine)) { j++; continue; }

        const narrLine = lines[j + 1]?.trim() || "";
        const procLine = lines[j + 2]?.trim() || "";

        // Adjusted for WCE Sequence (corrected off-by-two issue)
        const seq = dataLine.slice(7, 12).trim(); 
        // Adjusted for PWC (corrected off-by-three issue)
        const pwc = dataLine.slice(13, 18).trim();
        const equip = dataLine.slice(19, 30).trim();
        const wucCode = dataLine.slice(31, 45).trim();
        const date = dataLine.slice(75).trim(); 

        const narr = narrLine.startsWith("NARR:") ? narrLine.replace(/^NARR:\s*/i, "") : "";
        const procMatch = procLine.match(/-- .*?(\d{3})$/);
        const procId = procMatch ? procMatch[1] : "";

        wceBlocks.push([eventId, equipId || equip, wuc || wucCode, discrepancy, seq, pwc, narr]);

        j += 4;
      }
    }
  }

  // Display header info
  headerInfo.textContent =
    `Event ID: ${eventId}\n` +
    `Equip ID: ${equipId}\n` +
    `WUC: ${wuc}\n` +
    `Symbol: ${symbol}\n` +
    `Priority: ${priority}\n` +
    `Scheduled Date: ${scheduledDate}\n` +
    `Discrepancy: ${discrepancy}`;

  // Render WCE table
  for (const row of wceBlocks) {
    const tr = document.createElement("tr");
    row.forEach(col => {
      const td = document.createElement("td");
      td.textContent = col;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}

function downloadCSV() {
  const rows = Array.from(document.querySelectorAll("#outputTable tr"));
  const csv = rows.map(row =>
    Array.from(row.children).map(cell =>
      `"${cell.textContent.replace(/"/g, '""')}"`
    ).join(",")
  ).join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "parsed_data.csv";
  a.click();
}
</script>

</body>
</html>
